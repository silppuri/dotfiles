#!/usr/bin/env bash

# Check if we're in a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Error: Not in a git repository" >&2
    exit 1
fi

# Get the current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Run Claude with the review prompt
echo "Reviewing branch: $BRANCH"
echo "----------------------------------------"
claude -p "Review this branch's changes against master. Focus on actionable issues only.

CONTEXT:
- Branch: $BRANCH
- Base: master
- Changed files: $(git diff master...HEAD --name-only | wc -l)

REVIEW SCOPE:
1. Code style violations per CLAUDE.md (imports, error handling, null checks ??, unused vars)
2. Type safety issues (any types, missing assertions)
3. Test coverage gaps (async callbacks, database mocks, static dates)
4. Logic bugs or edge cases
5. Performance concerns

CONSTRAINTS:
- Read CLAUDE.md first for code guidelines
- Use 'git diff master...HEAD' to see changes
- Focus ONLY on changed lines and their immediate context
- Output plain text (no markdown)
- Be concise: list only issues requiring action

OUTPUT FORMAT:
For each issue:
- File:line - Brief issue description
- Why: One-line rationale
- Action: Specific command or fix to apply

If no issues found, output: 'No actionable issues found.'

Start review now."

exit $?
