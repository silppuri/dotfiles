#!/usr/bin/env bash

# Check if we're in a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Error: Not in a git repository" >&2
    exit 1
fi

# Detect default branch
DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
DEFAULT_BRANCH=${DEFAULT_BRANCH:-main}

# Get the current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "Reviewing branch: $BRANCH against $DEFAULT_BRANCH"
echo "----------------------------------------"

claude -p "Review changes on branch '$BRANCH' against $DEFAULT_BRANCH.

Read CLAUDE.md first, then run: git diff $DEFAULT_BRANCH...HEAD

RULES:
- Only flag issues in changed lines
- No markdown formatting
- If no issues: output 'No actionable issues found.'

CHECK FOR:
- CLAUDE.md violations (imports, error handling, ?? checks, unused vars)
- Type safety (any types, missing assertions)
- Missing test coverage (async callbacks, mocks, static dates)
- Logic bugs or edge cases

FORMAT (per issue):
file:line - Issue
Why: rationale
Fix: specific action" \
    --model sonnet \
    --allowedTools "Bash(git diff:*)" "Bash(git log:*)" "Bash(git show:*)" "Read" "Glob" "Grep"

exit $?
